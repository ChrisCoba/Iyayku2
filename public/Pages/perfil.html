<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/css/style.css" />
  <link rel="stylesheet" href="/css/menu.css" />
  <link rel="stylesheet" href="/css/perfil.css" />
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <title>Iyayku ‚Äì Perfil</title>
</head>
<body class="bg-blue-800 text-white font-sans">
  <header class="bg-white text-black flex flex-wrap items-center justify-between px-6 py-4 shadow-md">
    <!-- LOGO -->
    <div class="logo flex-shrink-0">
      <img src="/Images/logo.png" alt="Logo" class="h-12 object-contain" />
    </div>
    <!-- MEN√ö -->
    <nav id="main-menu" class="w-full md:w-auto md:flex md:items-center mt-4 md:mt-0 hidden md:block">
      <ul class="flex flex-col md:flex-row gap-4 letras_menu w-full md:w-auto">
        <li><a href="/index.html" class="hover-effect block py-2 px-4">Inicio</a></li>
        <li><a href="/Pages/nosotros.html" class="hover-effect block py-2 px-4">Nosotros</a></li>
        <li><a href="/Pages/editorial.html" class="hover-effect block py-2 px-4">Editorial</a></li>
        <li><a href="/Pages/servicios.html" class="hover-effect block py-2 px-4">Servicios</a></li>
        <li><a href="/Pages/contacto.html" class="hover-effect block py-2 px-4">Cont√°ctanos</a></li>
      </ul>
    </nav>
    <div class="social-icons">
      <a href="/Pages/registro_login.html" title="Iniciar sesi√≥n o registrarse">
        <div class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center hover:bg-blue-500 transition">
          <img src="/svgs/round-account-button-with-user-inside_icon-icons.com_72596.svg" alt="Usuario" class="w-6 h-6 text-white" />
        </div>
      </a>
      <!-- WhatsApp -->
      <a href="https://api.whatsapp.com/send?phone=593997000496&text=%C2%A1Hola%20Iyayku%20Innova%20Editores!%20me%20gustar%C3%ADa%20saber%20m%C3%A1s%20informaci%C3%B3n%20acerca%20de%20la%20asesor%C3%ADa%20y%20publicaci%C3%B3n%20de%20art%C3%ADculos%20cient%C3%ADficos.%20%E2%9C%8D%EF%B8%8F%F0%9F%93%8A%F0%9F%93%9D"
        target="_blank" rel="noopener noreferrer">
        <img src="/svgs/whatsapp_black_logo_icon_147050.svg" alt="WhatsApp" class="h-5 w-5 hover:scale-110 transition" />
      </a>
      <!-- Facebook -->
      <a href="https://www.facebook.com/Iyaykutec" target="_blank" rel="noopener noreferrer">
        <img src="/svgs/facebook_black_logo_icon_147136.svg" alt="Facebook" class="h-5 w-5 hover:scale-110 transition" />
      </a>
      <!-- Instagram -->
      <a href="https://www.instagram.com/iyaykutec" target="_blank" rel="noopener noreferrer">
        <img src="/svgs/instagram_black_logo_icon_147122.svg" alt="Instagram" class="h-5 w-5 hover:scale-110 transition" />
      </a>
      <!-- Buscar -->
      <a id="searchToggle" class="cursor-pointer">
        <img src="/svgs/searchmagnifierinterfacesymbol1_79893.svg" alt="Buscar" class="h-5 w-5 hover:scale-110 transition" />
      </a>
      <!-- Campo de b√∫squeda oculto -->
      <input id="searchInput" type="text" placeholder="Buscar..."
        class="hidden ml-2 px-2 py-1 rounded border border-gray-300 shadow text-black transition-all duration-300" />
    </div>
  </header>
  <main class="admin-dashboard-main">
    <!-- Sidebar -->
    <aside class="admin-sidebar">
      <div class="admin-sidebar-content">
        <div class="admin-title">Admin</div>
        <nav>
          <ul>
            <li>
              <a href="#" class="active">
                <span class="icon">üë§</span> Editar Perfil
              </a>
            </li>
            <li>
              <a href="#">
                <span class="icon">üßæ</span> Facturas
              </a>
            </li>
            <li>
              <a href="#">
                <span class="icon">üéì</span> Certificados
              </a>
            </li>
            <li>
              <a href="#">
                <span class="icon">üìù</span> Editar p√°gina
              </a>
            </li>
          </ul>
        </nav>
      </div>
    </aside>
    <!-- Main dashboard content -->
    <section class="admin-dashboard-content">
      <div class="admin-dashboard-blank"></div>
      <div class="admin-dashboard-welcome">
        ¬°Bienvenido, Administrador!
      </div>
      <div class="admin-dashboard-cards">
        <div class="admin-card card-perfil">
          <div class="icon">üë§</div>
          <div>Editar Perfil</div>
        </div>
        <div id="admin-usuarios-panel" class="admin-panel" style="display:none">
          <h3>Usuarios registrados</h3>
          <table id="admin-usuarios-table">
            <thead><tr><th>Nombre</th><th>Correo</th><th>Acciones</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="admin-card card-facturas">
          <div class="icon">üßæ</div>
          <div>Facturas</div>
        </div>
        <div id="admin-facturas-panel" class="admin-panel" style="display:none">
          <h3>Facturas</h3>
          <form id="form-factura" style="margin-bottom:16px;">
            <input type="number" name="usuario_id" placeholder="ID Usuario" required style="width:80px;">
            <input type="number" name="total" placeholder="Total" required step="0.01" style="width:80px;">
            <input type="text" name="items" placeholder='Items (JSON)' required style="width:200px;">
            <button type="submit">Agregar</button>
            <small>Ejemplo items: [{"nombre":"Servicio","cantidad":1,"precio":10}]</small>
          </form>
          <table id="admin-facturas-table">
            <thead><tr><th>ID</th><th>Usuario</th><th>Correo</th><th>Fecha</th><th>Total</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="admin-card card-certificados">
          <div class="icon">üéì</div>
          <div>Certificados</div>
        </div>
        <div id="admin-certificados-panel" class="admin-panel" style="display:none">
          <h3>Certificados</h3>
          <form id="form-certificado" style="margin-bottom:16px;">
            <input type="text" name="autor_nombre" placeholder="Autor" required style="width:120px;">
            <input type="text" name="articulo_titulo" placeholder="T√≠tulo" required style="width:120px;">
            <input type="url" name="articulo_url" placeholder="URL PDF" style="width:120px;">
            <input type="text" name="publicacion_id" placeholder="ID Publicaci√≥n (opcional)" style="width:80px;">
            <button type="submit">Agregar</button>
          </form>
          <table id="admin-certificados-table">
            <thead><tr><th>ID</th><th>Autor</th><th>T√≠tulo</th><th>PDF</th><th>P√°gina</th><th>Fecha</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="admin-card card-editar">
          <div class="icon">üìù</div>
          <div>Editar p√°gina</div>
        </div>
        <div id="admin-editar-panel" class="admin-panel" style="display:none;max-width:700px;">
          <h3>Editar cualquier secci√≥n de la web</h3>
          <form id="form-editar-seccion" style="margin-bottom:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
            <label>P√°gina:
              <select id="select-pagina" required style="min-width:120px;"></select>
            </label>
            <label>Secci√≥n:
              <select id="select-seccion" required style="min-width:120px;"></select>
            </label>
            <label>T√≠tulo:
              <input id="input-titulo" type="text" style="min-width:120px;" />
            </label>
            <button type="button" id="btn-cargar-seccion">Cargar</button>
          </form>
          <div id="editor-container" style="height:300px;background:white;color:black;"></div>
          <button id="btn-guardar-pagina" style="margin-top:10px;">Guardar Cambios</button>
        </div>
      </div>
    </section>
  </main>
  <footer class="footer">
    <div class="footer-col">
      <h3>Direcci√≥n</h3>
      <p>Direcci√≥n: Av. Amazonas y Col√≥n, Quito ‚Äì Ecuador</p>
    </div>
    <div class="footer-col">
      <h3>S√≠guenos</h3>
      <div class="footer-socials">
        <a href="https://api.whatsapp.com/send?phone=593997000496&text=%C2%A1Hola%20Iyayku%20Innova%20Editores!%20me%20gustar%C3%ADa%20saber%20m%C3%A1s%20informaci%C3%B3n%20acerca%20de%20la%20asesor%C3%ADa%20y%20publicaci%C3%B3n%20de%20art%C3%ADculos%20cient%C3%ADficos.%20%E2%9C%8D%EF%B8%8F%F0%9F%93%8A%F0%9F%93%9D" target="_blank" rel="noopener noreferrer">
          <img src="/svgs/whatsapp_black_logo_icon_147050.svg" alt="WhatsApp" />
        </a>
        <a href="https://www.facebook.com/Iyaykutec" target="_blank" rel="noopener noreferrer">
          <img src="/svgs/facebook_black_logo_icon_147136.svg" alt="Facebook" />
        </a>
        <a href="https://www.instagram.com/iyaykutec" target="_blank" rel="noopener noreferrer">
          <img src="/svgs/instagram_black_logo_icon_147122.svg" alt="Instagram" />
        </a>
      </div>
    </div>
    <div class="footer-col">
      <h3>Informaci√≥n</h3>
      <p>Email: iyayku@gmail.com</p>
      <p>Tel√©fonos: 0995000484 ¬∑ 0979369650 ¬∑ 0997000496</p>
    </div>
  </footer>
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  <script>
    // Permitir acceso solo si el usuario es administrador (correo admin@iyayku.com)
    document.addEventListener('DOMContentLoaded', function() {
      fetch('/api/status', { credentials: 'include' })
        .then(res => res.json())
        .then(data => {
          if (!data.usuario || data.usuario.correo !== 'admin@iyayku.com') {
            alert('Acceso restringido. Solo el administrador puede ingresar a esta p√°gina.');
            window.location.href = '/Pages/registro_login.html';
          }
        })
        .catch(() => {
          window.location.href = '/Pages/registro_login.html';
        });

      // --- Paneles admin ---
      const panels = {
        usuarios: document.getElementById('admin-usuarios-panel'),
        facturas: document.getElementById('admin-facturas-panel'),
        certificados: document.getElementById('admin-certificados-panel')
      };
      const cards = {
        usuarios: document.querySelector('.card-perfil'),
        facturas: document.querySelector('.card-facturas'),
        certificados: document.querySelector('.card-certificados')
      };
      panels.editar = document.getElementById('admin-editar-panel');
      cards.editar = document.querySelector('.card-editar');
      let quill;
      let paginasSecciones = [];
      function hideAllPanels() {
        Object.values(panels).forEach(p => p.style.display = 'none');
      }
      // Mostrar panel al hacer clic en la tarjeta
      cards.usuarios.addEventListener('click', () => {
        hideAllPanels();
        panels.usuarios.style.display = 'block';
        cargarUsuarios();
      });
      cards.facturas.addEventListener('click', () => {
        hideAllPanels();
        panels.facturas.style.display = 'block';
        cargarFacturas();
      });
      cards.certificados.addEventListener('click', () => {
        hideAllPanels();
        panels.certificados.style.display = 'block';
        cargarCertificados();
      });

      // --- Panel de edici√≥n avanzada ---
      cards.editar.addEventListener('click', () => {
        hideAllPanels();
        panels.editar.style.display = 'block';
        inicializarEditorAvanzado();
      });

      async function inicializarEditorAvanzado() {
        // Cargar p√°ginas y secciones disponibles
        if (!paginasSecciones.length) {
          const res = await fetch('/api/paginas_contenido/all', { credentials: 'include' });
          paginasSecciones = await res.json();
        }
        const paginas = [...new Set(paginasSecciones.map(x => x.pagina))];
        const selectPagina = document.getElementById('select-pagina');
        selectPagina.innerHTML = paginas.map(p => `<option value="${p}">${p}</option>`).join('');
        actualizarSecciones();
      }

      function actualizarSecciones() {
        const pagina = document.getElementById('select-pagina').value;
        const secciones = paginasSecciones.filter(x => x.pagina === pagina);
        const selectSeccion = document.getElementById('select-seccion');
        selectSeccion.innerHTML = secciones.map(s => `<option value="${s.seccion}">${s.seccion}</option>`).join('');
        if (secciones.length) {
          document.getElementById('input-titulo').value = secciones[0].titulo || '';
        }
      }

      document.getElementById('select-pagina').addEventListener('change', actualizarSecciones);
      document.getElementById('select-seccion').addEventListener('change', function() {
        const pagina = document.getElementById('select-pagina').value;
        const seccion = this.value;
        const obj = paginasSecciones.find(x => x.pagina === pagina && x.seccion === seccion);
        document.getElementById('input-titulo').value = obj ? (obj.titulo || '') : '';
      });

      document.getElementById('btn-cargar-seccion').addEventListener('click', function() {
        const pagina = document.getElementById('select-pagina').value;
        const seccion = document.getElementById('select-seccion').value;
        const obj = paginasSecciones.find(x => x.pagina === pagina && x.seccion === seccion);
        if (!quill) {
          quill = new Quill('#editor-container', { theme: 'snow' });
        }
        quill.root.innerHTML = obj ? (obj.contenido || '') : '';
        document.getElementById('input-titulo').value = obj ? (obj.titulo || '') : '';
      });

      document.getElementById('btn-guardar-pagina').addEventListener('click', async function() {
        const pagina = document.getElementById('select-pagina').value;
        const seccion = document.getElementById('select-seccion').value;
        const titulo = document.getElementById('input-titulo').value;
        const html = quill.root.innerHTML;
        const resp = await fetch('/api/paginas_contenido', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ pagina, seccion, titulo, contenido: html })
        });
        if (resp.ok) {
          alert('Secci√≥n actualizada');
          // Actualizar cache local
          const idx = paginasSecciones.findIndex(x => x.pagina === pagina && x.seccion === seccion);
          if (idx !== -1) {
            paginasSecciones[idx].contenido = html;
            paginasSecciones[idx].titulo = titulo;
          }
        } else {
          alert('Error al guardar');
        }
      });

      // --- Cargar usuarios ---
      async function cargarUsuarios() {
        const tbody = document.querySelector('#admin-usuarios-table tbody');
        tbody.innerHTML = '<tr><td colspan="3">Cargando...</td></tr>';
        try {
          const res = await fetch('/api/admin/usuarios', { credentials: 'include' });
          const usuarios = await res.json();
          tbody.innerHTML = '';
          usuarios.forEach(u => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td><input type="text" value="${u.nombre}" data-id="${u.id}" class="edit-nombre" style="width:120px"></td>
              <td><input type="email" value="${u.correo}" data-id="${u.id}" class="edit-correo" style="width:180px"></td>
              <td>
                <input type="password" placeholder="Nueva contrase√±a" data-id="${u.id}" class="edit-pass" style="width:120px">
                <button class="btn-guardar" data-id="${u.id}">Guardar</button>
              </td>
            `;
            tbody.appendChild(tr);
          });
          // Guardar cambios
          tbody.querySelectorAll('.btn-guardar').forEach(btn => {
            btn.addEventListener('click', async function() {
              const id = this.getAttribute('data-id');
              const nombre = tbody.querySelector(`.edit-nombre[data-id='${id}']`).value;
              const correo = tbody.querySelector(`.edit-correo[data-id='${id}']`).value;
              const contrasena = tbody.querySelector(`.edit-pass[data-id='${id}']`).value;
              const body = { nombre, correo };
              if (contrasena) body.contrasena = contrasena;
              const resp = await fetch(`/api/admin/usuarios/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(body)
              });
              if (resp.ok) {
                alert('Usuario actualizado');
                cargarUsuarios();
              } else {
                alert('Error al actualizar usuario');
              }
            });
          });
        } catch {
          tbody.innerHTML = '<tr><td colspan="3">Error al cargar usuarios</td></tr>';
        }
      }

      // --- Cargar facturas ---
      async function cargarFacturas() {
        const tbody = document.querySelector('#admin-facturas-table tbody');
        tbody.innerHTML = '<tr><td colspan="5">Cargando...</td></tr>';
        try {
          const res = await fetch('/api/admin/facturas', { credentials: 'include' });
          const facturas = await res.json();
          tbody.innerHTML = '';
          facturas.forEach(f => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${f.id}</td>
              <td>${f.usuario_nombre || ''}</td>
              <td>${f.usuario_correo || ''}</td>
              <td>${f.fecha ? new Date(f.fecha).toLocaleString() : ''}</td>
              <td>$${Number(f.total).toFixed(2)}</td>
            `;
            tbody.appendChild(tr);
          });
        } catch {
          tbody.innerHTML = '<tr><td colspan="5">Error al cargar facturas</td></tr>';
        }
      }

      // --- Cargar certificados ---
      async function cargarCertificados() {
        const tbody = document.querySelector('#admin-certificados-table tbody');
        tbody.innerHTML = '<tr><td colspan="6">Cargando...</td></tr>';
        try {
          const res = await fetch('/api/admin/certificados', { credentials: 'include' });
          const certs = await res.json();
          tbody.innerHTML = '';
          certs.forEach(c => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${c.id}</td>
              <td>${c.autor_nombre}</td>
              <td>${c.articulo_titulo}</td>
              <td>${c.articulo_url ? `<a href="${c.articulo_url}" target="_blank">PDF</a>` : ''}</td>
              <td>${c.articulo_pagina ? `<a href="${c.articulo_pagina}" target="_blank">Ver</a>` : ''}</td>
              <td>${c.fecha_emision ? new Date(c.fecha_emision).toLocaleString() : ''}</td>
            `;
            tbody.appendChild(tr);
          });
        } catch {
          tbody.innerHTML = '<tr><td colspan="6">Error al cargar certificados</td></tr>';
        }
      }

      // --- Agregar certificado ---
      document.getElementById('form-certificado').addEventListener('submit', async function(e) {
        e.preventDefault();
        const fd = new FormData(this);
        const body = Object.fromEntries(fd.entries());
        if (body.publicacion_id === "") delete body.publicacion_id;
        const resp = await fetch('/api/admin/certificados', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(body)
        });
        if (resp.ok) {
          alert('Certificado agregado');
          cargarCertificados();
          this.reset();
        } else {
          alert('Error al agregar certificado');
        }
      });

      // --- Agregar factura ---
      document.getElementById('form-factura').addEventListener('submit', async function(e) {
        e.preventDefault();
        const fd = new FormData(this);
        let items;
        try {
          items = JSON.parse(fd.get('items'));
          if (!Array.isArray(items)) throw new Error();
        } catch {
          alert('Items debe ser un JSON v√°lido de array');
          return;
        }
        const body = {
          usuario_id: Number(fd.get('usuario_id')),
          total: Number(fd.get('total')),
          items
        };
        const resp = await fetch('/api/admin/facturas', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(body)
        });
        if (resp.ok) {
          alert('Factura agregada');
          cargarFacturas();
          this.reset();
        } else {
          alert('Error al agregar factura');
        }
      });
    });
  </script>
  <script src="/script.js"></script>
</body>
</html>
