<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/css/style.css" />
  <link rel="stylesheet" href="/css/menu.css" />
  <link rel="stylesheet" href="/css/perfil.css" />
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <title>Iyayku ‚Äì Perfil</title>
</head>
<body class="bg-blue-800 text-white font-sans">
  <header class="bg-white text-black flex flex-wrap items-center justify-between px-6 py-4 shadow-md">
    <div class="logo flex-shrink-0">
      <img src="/img/logo" alt="Logo" class="h-8 object-contain" />
    </div>
    <nav id="main-menu" class="w-full md:w-auto md:flex md:items-center mt-4 md:mt-0 hidden md:block">
      <ul class="flex flex-col md:flex-row gap-4 letras_menu w-full md:w-auto">
        <li><a href="/index.html" class="hover-effect block py-2 px-4">Inicio</a></li>
        <li><a href="/Pages/nosotros.html" class="hover-effect block py-2 px-4">Nosotros</a></li>
        <li><a href="/Pages/editorial.html" class="hover-effect block py-2 px-4">Editorial</a></li>
        <li><a href="/Pages/servicios.html" class="hover-effect block py-2 px-4">Servicios</a></li>
        <li><a href="/Pages/contacto.html" class="hover-effect block py-2 px-4">Cont√°ctanos</a></li>
      </ul>
    </nav>
    <div class="social-icons">
      <a href="/Pages/registro_login.html" title="Iniciar sesi√≥n o registrarse">
        <div class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center hover:bg-blue-500 transition">
          <img src="/svg/user" alt="Usuario" class="w-6 h-6 text-white" />
        </div>
      </a>
      <!-- WhatsApp -->
      <a href="https://api.whatsapp.com/send?phone=593997000496&text=%C2%A1Hola%20Iyayku%20Innova%20Editores!%20me%20gustar%C3%ADa%20saber%20m%C3%A1s%20informaci%C3%B3n%20acerca%20de%20la%20asesor%C3%ADa%20y%20publicaci%C3%B3n%20de%20art%C3%ADculos%20cient%C3%ADficos.%20%E2%9C%8D%EF%B8%8F%F0%9F%93%8A%F0%9F%93%9D"
        target="_blank" rel="noopener noreferrer">
        <img src="/img/whatsapp" alt="WhatsApp" class="h-5 w-5 hover:scale-110 transition" />
      </a>
      <!-- Facebook -->
      <a href="https://www.facebook.com/Iyaykutec" target="_blank" rel="noopener noreferrer">
        <img src="/img/facebook" alt="Facebook" class="h-5 w-5 hover:scale-110 transition" />
      </a>
      <!-- Instagram -->
      <a href="https://www.instagram.com/iyaykutec" target="_blank" rel="noopener noreferrer">
        <img src="/img/instagram" alt="Instagram" class="h-5 w-5 hover:scale-110 transition" />
      </a>
      <!-- Buscar -->
      <a id="searchToggle" class="cursor-pointer">
        <img src="/img/lupa" alt="Buscar" class="h-5 w-5 hover:scale-110 transition" />
      </a>
      <!-- Campo de b√∫squeda oculto -->
      <input id="searchInput" type="text" placeholder="Buscar..."
        class="hidden ml-2 px-2 py-1 rounded border border-gray-300 shadow text-black transition-all duration-300" />
    </div>
  </header>
  <!-- LOGIN STATUS BANNER -->
  <div id="login-status-banner" style="display:none;position:fixed;top:0;right:0;z-index:9999;background:#3498db;color:#fff;padding:8px 18px;border-radius:0 0 0 12px;font-weight:600;box-shadow:0 2px 8px rgba(0,0,0,0.10);">
    <span id="login-status-text"></span>
    <a id="perfil-link" href="/Pages/perfil.html" style="color:#fff;text-decoration:underline;margin-left:10px;display:none;">Ir a perfil</a>
  </div>
  <main class="admin-dashboard-main admin-dashboard-main-blanco">
    <!-- Sidebar -->
    <aside class="admin-sidebar">
      <div class="admin-sidebar-content">
        <div class="admin-title">Admin</div>
        <nav>
          <ul>
            <li>
              <a href="#" class="active">
                <span class="icon">üë§</span> Editar Perfil
              </a>
            </li>
            <li>
              <a href="#">
                <span class="icon">üßæ</span> Facturas
              </a>
            </li>
            <li>
              <a href="#">
                <span class="icon">üéì</span> Certificados
              </a>
            </li>
            <li>
              <a href="#">
                <span class="icon">üìù</span> Editar p√°gina
              </a>
            </li>
          </ul>
        </nav>
      </div>
    </aside>
    <!-- Main dashboard content -->
    <section class="admin-dashboard-content">
      <div class="admin-dashboard-blank"></div>
      <div class="admin-dashboard-welcome">
        ¬°Bienvenido, Administrador!
      </div>
      <div class="admin-dashboard-cards">
        <div class="admin-card card-servicios">
          <div class="icon">üõí</div>
          <div>Servicios</div>
        </div>
        <div class="admin-card card-pedidos">
          <div class="icon">üìÑ</div>
          <div>Pedidos</div>
        </div>
        <div id="admin-servicios-panel" class="admin-panel" style="display:none">
          <h3 style="margin-bottom:16px;color:#1e293b;font-size:1.3em;">Administrar servicios</h3>
          <div style="background:#fff;border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,0.08);padding:24px 18px;max-width:700px;margin:auto;">
            <form id="form-servicio" style="display:flex;gap:8px;align-items:center;margin-bottom:18px;">
              <input type="text" name="nombre" placeholder="Nombre del servicio" required style="min-width:120px;">
              <input type="number" name="precio" placeholder="Precio" required step="0.01" style="width:80px;">
              <input type="text" name="descripcion" placeholder="Descripci√≥n" style="min-width:180px;">
              <button type="submit" style="background:#059669;color:#fff;border:none;padding:6px 16px;border-radius:6px;cursor:pointer;">A√±adir servicio</button>
            </form>
            <table id="admin-servicios-table" style="width:100%;border-collapse:collapse;">
              <thead style="background:#f1f5f9;color:#222;"><tr><th style="padding:8px 4px;border-bottom:1px solid #e5e7eb;">Nombre</th><th style="padding:8px 4px;border-bottom:1px solid #e5e7eb;">Precio</th><th style="padding:8px 4px;border-bottom:1px solid #e5e7eb;">Estado</th><th style="padding:8px 4px;border-bottom:1px solid #e5e7eb;">Acci√≥n</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        <div class="admin-card card-perfil">
          <div class="icon">üë§</div>
          <div>Editar Perfil</div>
        </div>
        <div id="admin-usuarios-panel" class="admin-panel" style="display:none">
          <h3 style="margin-bottom:16px;color:#1e293b;font-size:1.3em;">Usuarios registrados</h3>
          <div style="background:#fff;border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,0.08);padding:24px 18px;max-width:600px;margin:auto;">
            <table id="admin-usuarios-table" style="width:100%;border-collapse:collapse;">
              <thead style="background:#f1f5f9;color:#222;"><tr><th style="padding:8px 4px;border-bottom:1px solid #e5e7eb;">Nombre</th><th style="padding:8px 4px;border-bottom:1px solid #e5e7eb;">Correo</th><th style="padding:8px 4px;border-bottom:1px solid #e5e7eb;">Acci√≥n</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        <div class="admin-card card-facturas">
          <div class="icon">üßæ</div>
          <div>Facturas</div>
        </div>
        <div id="admin-facturas-panel" class="admin-panel" style="display:none">
          <h3 style="margin-bottom:16px;color:#1e293b;font-size:1.3em;">Facturas</h3>
          <form id="form-factura" style="margin-bottom:16px;display:flex;gap:8px;align-items:center;">
            <input type="number" name="usuario_id" placeholder="ID Usuario" required style="width:80px;">
            <input type="number" name="total" placeholder="Total" required step="0.01" style="width:80px;">
            <input type="text" name="items" placeholder='Items (JSON)' required style="width:200px;">
            <button type="submit" style="background:#059669;color:#fff;border:none;padding:6px 16px;border-radius:6px;cursor:pointer;">Agregar</button>
            <small>Ejemplo items: [{"nombre":"Servicio","cantidad":1,"precio":10}]</small>
          </form>
          <div style="background:#fff;border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,0.08);padding:24px 18px;max-width:700px;margin:auto;">
            <table id="admin-facturas-table" style="width:100%;border-collapse:collapse;">
              <thead style="background:#f1f5f9;color:#222;"><tr><th style="padding:8px 4px;border-bottom:1px solid #e5e7eb;">ID</th><th style="padding:8px 4px;border-bottom:1px solid #e5e7eb;">Usuario</th><th style="padding:8px 4px;border-bottom:1px solid #e5e7eb;">Correo</th><th style="padding:8px 4px;border-bottom:1px solid #e5e7eb;">Fecha</th><th style="padding:8px 4px;border-bottom:1px solid #e5e7eb;">Total</th><th style="padding:8px 4px;border-bottom:1px solid #e5e7eb;">PDF</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        <div class="admin-card card-certificados">
          <div class="icon">üéì</div>
          <div>Certificados</div>
        </div>
        <div id="admin-certificados-panel" class="admin-panel" style="display:none">
          <h3 style="margin-bottom:16px;color:#1e293b;font-size:1.3em;">Certificados</h3>
          <form id="form-certificado" style="margin-bottom:16px;display:flex;gap:8px;align-items:center;">
            <input type="text" name="autor_nombre" placeholder="Autor" required style="width:120px;">
            <input type="text" name="articulo_titulo" placeholder="T√≠tulo" required style="width:120px;">
            <input type="url" name="articulo_url" placeholder="URL PDF" style="width:120px;">
            <input type="text" name="publicacion_id" placeholder="ID Publicaci√≥n (opcional)" style="width:80px;">
            <button type="submit" style="background:#059669;color:#fff;border:none;padding:6px 16px;border-radius:6px;cursor:pointer;">Agregar</button>
          </form>
          <div style="background:#fff;border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,0.08);padding:24px 18px;max-width:700px;margin:auto;">
            <table id="admin-certificados-table" style="width:100%;border-collapse:collapse;">
              <thead style="background:#f1f5f9;color:#222;"><tr><th style="padding:8px 4px;border-bottom:1px solid #e5e7eb;">ID</th><th style="padding:8px 4px;border-bottom:1px solid #e5e7eb;">Autor</th><th style="padding:8px 4px;border-bottom:1px solid #e5e7eb;">T√≠tulo</th><th style="padding:8px 4px;border-bottom:1px solid #e5e7eb;">PDF</th><th style="padding:8px 4px;border-bottom:1px solid #e5e7eb;">P√°gina</th><th style="padding:8px 4px;border-bottom:1px solid #e5e7eb;">Fecha</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        <div class="admin-card card-editar">
          <div class="icon">üìù</div>
          <div>Editar p√°gina</div>
        </div>
        <div id="admin-editar-panel" class="admin-panel" style="display:none;max-width:900px;">
        Panel Pedidos Admin
        <div id="admin-pedidos-panel" class="admin-panel" style="display:none;max-width:900px;">
          <h3>Pedidos de clientes</h3>
          <div id="msg-admin-pedidos" style="margin-bottom:10px;color:#2563eb;font-weight:bold;"></div>
          <table id="tabla-admin-pedidos" style="width:100%;border-collapse:collapse;background:#fff;color:#222;border-radius:8px;box-shadow:0 2px 12px rgba(0,0,0,0.08);">
            <thead style="background:#f1f5f9;color:#222;"><tr><th>Cliente</th><th>Fecha</th><th>Estado</th><th>Requisitos</th><th>Art√≠culo</th><th>PDF Corregido</th><th>Acci√≥n</th></tr></thead>
            <tbody></tbody>
          </table>
          <!-- Panel para subir PDF corregido y publicar -->
          <div id="panel-correccion-pedido" style="display:none;margin-top:24px;background:#f8fafc;padding:18px;border-radius:8px;">
            <h4>Corregir y devolver PDF</h4>
            <form id="form-correccion-pedido" style="display:flex;flex-wrap:wrap;gap:12px;align-items:center;">
              <input type="hidden" name="pedido_id" />
              <label>PDF corregido:
                <input type="file" name="pdf_correccion" accept="application/pdf" required />
              </label>
              <button type="submit" style="background:#059669;color:#fff;border:none;padding:6px 16px;border-radius:6px;cursor:pointer;">Devolver PDF corregido</button>
            </form>
            <button id="btn-publicar-articulo" style="background:#2563eb;color:#fff;border:none;padding:6px 16px;border-radius:6px;cursor:pointer;margin-top:10px;">Publicar art√≠culo</button>
            <div id="msg-correccion-pedido" style="margin-top:10px;color:#059669;font-weight:bold;"></div>
          </div>
        </div>
          <h3>Editar cualquier secci√≥n de la web</h3>
          <form id="form-editar-seccion" style="margin-bottom:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
            <label title="Selecciona la p√°gina que quieres editar">P√°gina:
              <select id="select-pagina" required style="min-width:120px;"></select>
            </label>
            <label title="Selecciona la secci√≥n de la p√°gina">Secci√≥n:
              <select id="select-seccion" required style="min-width:120px;"></select>
            </label>
            <label title="T√≠tulo de la secci√≥n">T√≠tulo:
              <input id="input-titulo" type="text" style="min-width:120px;" />
            </label>
            <button type="button" id="btn-cargar-seccion" title="Recargar el contenido de la secci√≥n">Cargar</button>
          </form>
          <div id="loader-editar" style="display:none;text-align:center;margin-bottom:10px;">
            <span style="color:#2563eb;font-weight:bold;">Cargando...</span>
          </div>
          <div id="msg-editar" style="display:none;text-align:center;margin-bottom:10px;"></div>
          <div style="display:flex;gap:16px;align-items:flex-start;">
            <div style="flex:1;min-width:350px;">
              <div style="margin-bottom:4px;display:flex;align-items:center;gap:8px;">
                <button type="button" id="btn-modo-visual" class="btn-modo" style="padding:2px 8px;" title="Editar visualmente el contenido">Editor Visual</button>
                <button type="button" id="btn-modo-html" class="btn-modo" style="padding:2px 8px;" title="Editar el HTML directamente">HTML</button>
              </div>
              <div id="editor-container" style="height:300px;background:white;color:black;"></div>
              <textarea id="editor-html" style="display:none;width:100%;height:300px;font-family:monospace;font-size:1em;" title="Edita el HTML aqu√≠"></textarea>
            </div>
            <div style="flex:1;min-width:350px;">
              <label style="font-weight:bold;">Vista previa:</label>
              <div id="preview-html" style="border:1px solid #ccc;background:#fff;color:#222;padding:8px;min-height:300px;"></div>
            </div>
          </div>
          <button id="btn-guardar-pagina" style="margin-top:10px;">Guardar Cambios</button>
        </div>
      </div>
    </section>
  </main>
  <footer class="footer">
    <div class="footer-col">
      <h3>Direcci√≥n</h3>
      <p>Direcci√≥n: Av. Amazonas y Col√≥n, Quito ‚Äì Ecuador</p>
    </div>
    <div class="footer-col">
      <h3>S√≠guenos</h3>
      <div class="footer-socials">
        <a href="https://api.whatsapp.com/send?phone=593997000496&text=%C2%A1Hola%20Iyayku%20Innova%20Editores!%20me%20gustar%C3%ADa%20saber%20m%C3%A1s%20informaci%C3%B3n%20acerca%20de%20la%20asesor%C3%ADa%20y%20publicaci%C3%B3n%20de%20art%C3%ADculos%20cient%C3%ADficos.%20%E2%9C%8D%EF%B8%8F%F0%9F%93%8A%F0%9F%93%9D" target="_blank" rel="noopener noreferrer">
          <img src="/img/whatsapp" alt="WhatsApp" />
        </a>
        <a href="https://www.facebook.com/Iyaykutec" target="_blank" rel="noopener noreferrer">
          <img src="/img/facebook" alt="Facebook" />
        </a>
        <a href="https://www.instagram.com/iyaykutec" target="_blank" rel="noopener noreferrer">
          <img src="/img/instagram" alt="Instagram" />
        </a>
      </div>
    </div>
    <div class="footer-col">
      <h3>Informaci√≥n</h3>
      <p>Email: iyayku@gmail.com</p>
      <p>Tel√©fonos: 0995000484 ¬∑ 0979369650 ¬∑ 0997000496</p>
    </div>
  </footer>
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  <script src="/script.js"></script>
  <script>
    // Mostrar banner de login si est√° logueado
    document.addEventListener('DOMContentLoaded', function() {
      fetch('/api/status', { credentials: 'include' })
        .then(res => res.json())
        .then(data => {
          if (data.usuario && data.usuario.correo) {
            const banner = document.getElementById('login-status-banner');
            const text = document.getElementById('login-status-text');
            const perfilLink = document.getElementById('perfil-link');
            text.textContent = `Sesi√≥n iniciada: ${data.usuario.nombre || data.usuario.correo}`;
            if (data.usuario.correo === 'admin@iyayku.com') {
              perfilLink.style.display = '';
            } else {
              perfilLink.style.display = 'none';
            }
            banner.style.display = '';
          }
        });

      // --- Mostrar/ocultar paneles admin ---
      function hideAllPanels() {
        document.getElementById('admin-usuarios-panel').style.display = 'none';
        document.getElementById('admin-facturas-panel').style.display = 'none';
        document.getElementById('admin-certificados-panel').style.display = 'none';
        document.getElementById('admin-editar-panel').style.display = 'none';
      }
      // Asocia cada tarjeta con su panel
      const cardPanelMap = {
        'card-perfil': 'admin-usuarios-panel',
        'card-facturas': 'admin-facturas-panel',
        'card-certificados': 'admin-certificados-panel',
        'card-editar': 'admin-editar-panel',
        'card-servicios': 'admin-servicios-panel'
      };
      document.querySelectorAll('.admin-card').forEach(card => {
        card.addEventListener('click', function() {
          hideAllPanels();
          const panelId = cardPanelMap[card.classList[1]];
          if (panelId) {
            document.getElementById(panelId).style.display = '';
            // Cargar datos autom√°ticamente al mostrar panel
            if (panelId === 'admin-usuarios-panel') cargarUsuariosAdmin();
            if (panelId === 'admin-facturas-panel') cargarFacturasAdmin();
            if (panelId === 'admin-certificados-panel') cargarCertificadosAdmin();
            if (panelId === 'admin-servicios-panel') cargarServiciosAdmin();
            if (panelId === 'admin-editar-panel') {
              // Inicializar editor visual y eventos SOLO una vez
              if (!window.quill) {
                window.quill = new Quill('#editor-container', { theme: 'snow' });
                document.getElementById('btn-modo-visual').onclick = modoVisualHtml;
                document.getElementById('btn-modo-html').onclick = modoSoloHtml;
                document.getElementById('btn-cargar-seccion').onclick = cargarContenidoSeccion;
                document.getElementById('select-seccion').onchange = cargarContenidoSeccion;
                window.quill.on('text-change', function() {
                  document.getElementById('editor-html').value = window.quill.root.innerHTML;
                  document.getElementById('preview-html').innerHTML = window.quill.root.innerHTML;
                });
                document.getElementById('editor-html').addEventListener('input', function() {
                  document.getElementById('preview-html').innerHTML = this.value;
                });
                const btnGuardar = document.getElementById('btn-guardar-pagina');
                btnGuardar.onclick = async function() {
                  const pagina = document.getElementById('select-pagina').value;
                  const seccion = document.getElementById('select-seccion').value;
                  const titulo = document.getElementById('input-titulo').value.trim();
                  const contenido = document.getElementById('editor-html').style.display === 'none' ? window.quill.root.innerHTML : document.getElementById('editor-html').value;
                  const msg = document.getElementById('msg-editar');
                  msg.style.display = 'none';
                  if (!titulo) {
                    msg.textContent = 'El t√≠tulo no puede estar vac√≠o.';
                    msg.style.display = '';
                    return;
                  }
                  if (!contenido || contenido.trim() === '') {
                    msg.textContent = 'El contenido no puede estar vac√≠o.';
                    msg.style.display = '';
                    return;
                  }
                  btnGuardar.disabled = true;
                  btnGuardar.textContent = 'Guardando...';
                  try {
                    const res = await fetch('/api/admin/contenido', {
                      method: 'PUT',
                      headers: { 'Content-Type': 'application/json' },
                      credentials: 'include',
                      body: JSON.stringify({ pagina, seccion, titulo, contenido })
                    });
                    if (res.ok) {
                      msg.innerHTML = '‚úÖ Secci√≥n actualizada correctamente. <button id="btn-deshacer-editar" style="margin-left:10px;">Deshacer</button>';
                      msg.style.display = '';
                      let lastContent = contenido;
                      document.getElementById('btn-deshacer-editar').onclick = async function() {
                        btnGuardar.disabled = true;
                        btnGuardar.textContent = 'Restaurando...';
                        try {
                          await cargarContenidoSeccion();
                          msg.textContent = 'Se restaur√≥ el contenido anterior.';
                        } catch (e) {
                          msg.textContent = 'Error al restaurar: ' + (e.message || e);
                        }
                        btnGuardar.disabled = false;
                        btnGuardar.textContent = 'Guardar Cambios';
                      };
                    } else {
                      msg.textContent = 'Error al guardar: ' + (await res.text());
                      msg.style.display = '';
                    }
                  } catch (e) {
                    msg.textContent = 'Error JS: ' + (e.message || e);
                    msg.style.display = '';
                  }
                  btnGuardar.disabled = false;
                  btnGuardar.textContent = 'Guardar Cambios';
                };
              }
              cargarPaginasYSecciones();
            }
            // --- Pedidos admin ---
            if (panelId === 'admin-pedidos-panel') cargarPedidosAdmin();
          }
        });
      });
      // --- Funciones para cargar datos admin ---
      // --- Servicios admin ---
      async function cargarServiciosAdmin() {
        const table = document.querySelector('#admin-servicios-table tbody');
        if (!table) return;
        table.innerHTML = '<tr><td colspan="4">Cargando...</td></tr>';
        try {
          const res = await fetch('/api/servicios', { credentials: 'include' });
          const data = await res.json();
          if (!Array.isArray(data)) {
            table.innerHTML = `<tr><td colspan='4'>Respuesta inesperada: ${JSON.stringify(data)}</td></tr>`;
            return;
          }
          if (data.length === 0) {
            table.innerHTML = '<tr><td colspan="4">No hay servicios.</td></tr>';
            return;
          }
          table.innerHTML = '';
          data.forEach(s => {
            table.innerHTML += `<tr>
              <td style='padding:8px 4px;border-bottom:1px solid #e5e7eb;'>${s.nombre || ''}</td>
              <td style='padding:8px 4px;border-bottom:1px solid #e5e7eb;'>${s.precio || ''}</td>
              <td style='padding:8px 4px;border-bottom:1px solid #e5e7eb;'>${s.activo ? 'Activo' : 'Desactivado'}</td>
              <td style='padding:8px 4px;border-bottom:1px solid #e5e7eb;'>
                <button class='btn-desactivar-serv' data-id='${s.id}' style='background:#f59e42;color:#fff;border:none;padding:4px 10px;border-radius:6px;cursor:pointer;margin-right:6px;'>${s.activo ? 'Desactivar' : 'Activar'}</button>
                <button class='btn-eliminar-serv' data-id='${s.id}' style='background:#ef4444;color:#fff;border:none;padding:4px 10px;border-radius:6px;cursor:pointer;'>Eliminar</button>
              </td>
            </tr>`;
          });
          // Eventos desactivar/activar
          table.querySelectorAll('.btn-desactivar-serv').forEach(btn => {
            btn.addEventListener('click', async function() {
              const id = btn.getAttribute('data-id');
              const accion = btn.textContent.includes('Desactivar') ? 'desactivar' : 'activar';
              if (!confirm(`¬øSeguro que desea ${accion} este servicio?`)) return;
              btn.disabled = true;
              btn.textContent = 'Procesando...';
              try {
                // Obtener datos actuales del servicio para mantener nombre, descripcion, precio, orden
                const resGet = await fetch(`/api/servicios`, { credentials: 'include' });
                const servicios = await resGet.json();
                const serv = Array.isArray(servicios) ? servicios.find(s => s.id == id) : null;
                if (!serv) {
                  alert('No se encontr√≥ el servicio.');
                  btn.disabled = false;
                  btn.textContent = accion === 'desactivar' ? 'Desactivar' : 'Activar';
                  return;
                }
                const activo = accion === 'activar';
                const res = await fetch(`/api/admin/servicios/${id}`, {
                  method: 'PUT',
                  headers: { 'Content-Type': 'application/json' },
                  credentials: 'include',
                  body: JSON.stringify({
                    nombre: serv.nombre,
                    descripcion: serv.descripcion,
                    precio: serv.precio,
                    activo,
                    orden: serv.orden || 0
                  })
                });
                if (!res.ok) {
                  const text = await res.text();
                  alert('Error: ' + text);
                } else {
                  cargarServiciosAdmin();
                }
              } catch (e) {
                alert('Error JS: ' + (e.message || e));
              }
            });
          });
          // Evento eliminar
          table.querySelectorAll('.btn-eliminar-serv').forEach(btn => {
            btn.addEventListener('click', async function() {
              const id = btn.getAttribute('data-id');
              if (!confirm('¬øSeguro que desea eliminar este servicio?')) return;
              btn.disabled = true;
              btn.textContent = 'Eliminando...';
              try {
                const res = await fetch(`/api/admin/servicios/${id}`, {
                  method: 'DELETE',
                  credentials: 'include'
                });
                if (!res.ok) {
                  const text = await res.text();
                  alert('Error: ' + text);
                } else {
                  cargarServiciosAdmin();
                }
              } catch (e) {
                alert('Error JS: ' + (e.message || e));
              }
            });
          });
        } catch (e) {
          table.innerHTML = `<tr><td colspan="4">Error JS: ${e.message || e}</td></tr>`;
        }
      }
      // Evento a√±adir servicio
      const formServicio = document.getElementById('form-servicio');
      if (formServicio) {
        formServicio.addEventListener('submit', async function(e) {
          e.preventDefault();
          const nombre = formServicio.nombre.value.trim();
          const precio = parseFloat(formServicio.precio.value);
          const descripcion = formServicio.descripcion.value.trim();
          if (!nombre || isNaN(precio)) return alert('Completa los campos correctamente.');
          formServicio.querySelector('button[type="submit"]').disabled = true;
          try {
            const res = await fetch('/api/admin/servicios', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify({ nombre, precio, descripcion, orden: 0 })
            });
            if (!res.ok) {
              const text = await res.text();
              alert('Error: ' + text);
            } else {
              formServicio.reset();
              cargarServiciosAdmin();
            }
          } catch (e) {
            alert('Error JS: ' + (e.message || e));
          }
          formServicio.querySelector('button[type="submit"]').disabled = false;
        });
      }
      async function cargarUsuariosAdmin() {
        const table = document.querySelector('#admin-usuarios-table tbody');
        if (!table) return;
        table.innerHTML = '<tr><td colspan="3">Cargando...</td></tr>';
        try {
          const res = await fetch('/api/admin/usuarios', { credentials: 'include' });
          if (!res.ok) {
            const text = await res.text();
            table.innerHTML = `<tr><td colspan='3'>Error HTTP: ${res.status} - ${text}</td></tr>`;
            return;
          }
          const data = await res.json();
          if (!Array.isArray(data)) {
            table.innerHTML = `<tr><td colspan='3'>Respuesta inesperada: ${JSON.stringify(data)}</td></tr>`;
            return;
          }
          if (data.length === 0) {
            table.innerHTML = '<tr><td colspan="3">No hay usuarios.</td></tr>';
            return;
          }
          table.innerHTML = '';
          data.forEach(u => {
            table.innerHTML += `<tr>
              <td style='padding:8px 4px;border-bottom:1px solid #e5e7eb;'>${u.nombre || ''}</td>
              <td style='padding:8px 4px;border-bottom:1px solid #e5e7eb;'>${u.correo || ''}</td>
              <td style='padding:8px 4px;border-bottom:1px solid #e5e7eb;'>
                <button class='btn-cambiar-pass' data-id='${u.id}' style='background:#2563eb;color:#fff;border:none;padding:4px 10px;border-radius:6px;cursor:pointer;'>Cambiar contrase√±a</button>
              </td>
            </tr>`;
          });
          // Agregar evento para cambiar contrase√±a
          table.querySelectorAll('.btn-cambiar-pass').forEach(btn => {
            btn.addEventListener('click', async function() {
              const userId = btn.getAttribute('data-id');
              const newPass = prompt('Nueva contrase√±a para el usuario:');
              if (!newPass) return;
              btn.disabled = true;
              btn.textContent = 'Guardando...';
              try {
                const res = await fetch(`/api/admin/usuarios/${userId}`, {
                  method: 'PUT',
                  headers: { 'Content-Type': 'application/json' },
                  credentials: 'include',
                  body: JSON.stringify({ contrase√±a: newPass })
                });
                if (!res.ok) {
                  const text = await res.text();
                  alert('Error: ' + text);
                } else {
                  alert('Contrase√±a actualizada correctamente.');
                }
              } catch (e) {
                alert('Error JS: ' + (e.message || e));
              }
              btn.disabled = false;
              btn.textContent = 'Cambiar contrase√±a';
            });
          });
        } catch (e) {
          table.innerHTML = `<tr><td colspan="3">Error JS: ${e.message || e}</td></tr>`;
        }
      }

      async function cargarFacturasAdmin() {
        const table = document.querySelector('#admin-facturas-table tbody');
        if (!table) return;
        table.innerHTML = '<tr><td colspan="6">Cargando...</td></tr>';
        try {
          const res = await fetch('/api/admin/facturas', { credentials: 'include' });
          if (!res.ok) {
            const text = await res.text();
            table.innerHTML = `<tr><td colspan='6'>Error HTTP: ${res.status} - ${text}</td></tr>`;
            return;
          }
          const data = await res.json();
          if (!Array.isArray(data)) {
            table.innerHTML = `<tr><td colspan='6'>Respuesta inesperada: ${JSON.stringify(data)}</td></tr>`;
            return;
          }
          if (data.length === 0) {
            table.innerHTML = '<tr><td colspan="6">No hay facturas.</td></tr>';
            return;
          }
          table.innerHTML = '';
          for (const f of data) {
            let usuario = f.usuario_nombre ? `${f.usuario_nombre} (#${f.usuario_id})` : (f.usuario_id || '');
            table.innerHTML += `<tr>
              <td style='padding:8px 4px;border-bottom:1px solid #e5e7eb;'>${f.id}</td>
              <td style='padding:8px 4px;border-bottom:1px solid #e5e7eb;'>${usuario}</td>
              <td style='padding:8px 4px;border-bottom:1px solid #e5e7eb;'>${f.correo || ''}</td>
              <td style='padding:8px 4px;border-bottom:1px solid #e5e7eb;'>${f.fecha || ''}</td>
              <td style='padding:8px 4px;border-bottom:1px solid #e5e7eb;'>${f.total || ''}</td>
              <td style='padding:8px 4px;border-bottom:1px solid #e5e7eb;'>${f.pdfUrl ? `<button class='btn-ver-pdf' data-url='${f.pdfUrl}' style='background:#2563eb;color:#fff;border:none;padding:4px 10px;border-radius:6px;cursor:pointer;'>Ver PDF</button>` : ''}</td>
            </tr>`;
          }
          table.querySelectorAll('.btn-ver-pdf').forEach(btn => {
            btn.addEventListener('click', function() {
              const url = btn.getAttribute('data-url');
              if (url) window.open(url, '_blank');
            });
          });
        } catch (e) {
          table.innerHTML = `<tr><td colspan="6">Error JS: ${e.message || e}</td></tr>`;
        }
      }

      async function cargarCertificadosAdmin() {
        const table = document.querySelector('#admin-certificados-table tbody');
        if (!table) return;
        table.innerHTML = '<tr><td colspan="6">Cargando...</td></tr>';
        try {
          const res = await fetch('/api/certificados-todos', { credentials: 'include' });
          const data = await res.json();
          if (!Array.isArray(data) || data.length === 0) {
            table.innerHTML = '<tr><td colspan="6">No hay certificados.</td></tr>';
            return;
          }
          table.innerHTML = '';
          data.forEach(c => {
            table.innerHTML += `<tr>
              <td style='padding:8px 4px;border-bottom:1px solid #e5e7eb;'>${c.id}</td>
              <td style='padding:8px 4px;border-bottom:1px solid #e5e7eb;'>${c.autor_nombre || ''}</td>
              <td style='padding:8px 4px;border-bottom:1px solid #e5e7eb;'>${c.articulo_titulo || ''}</td>
              <td style='padding:8px 4px;border-bottom:1px solid #e5e7eb;'>${c.articulo_url ? `<button class='btn-ver-pdf' data-url='${c.articulo_url}' style='background:#2563eb;color:#fff;border:none;padding:4px 10px;border-radius:6px;cursor:pointer;'>Ver PDF</button>` : ''}</td>
              <td style='padding:8px 4px;border-bottom:1px solid #e5e7eb;'>${c.pagina || ''}</td>
              <td style='padding:8px 4px;border-bottom:1px solid #e5e7eb;'>${c.fecha || ''}</td>
            </tr>`;
          });
          table.querySelectorAll('.btn-ver-pdf').forEach(btn => {
            btn.addEventListener('click', function() {
              const url = btn.getAttribute('data-url');
              if (url) window.open(url, '_blank');
            });
          });
        } catch (e) {
          table.innerHTML = '<tr><td colspan="6">Error al cargar certificados.</td></tr>';
        }
      }
      // // --- Editar p√°gina admin ---
      // // --- Pedidos admin ---
      // async function cargarPedidosAdmin() {
      //   const table = document.getElementById('tabla-admin-pedidos').getElementsByTagName('tbody')[0];
      //   const msg = document.getElementById('msg-admin-pedidos');
      //   table.innerHTML = '<tr><td colspan="7">Cargando...</td></tr>';
      //   msg.textContent = '';
      //   try {
      //     const res = await fetch('/api/pedidos', { credentials: 'include' });
      //     const pedidos = await res.json();
      //     if (!Array.isArray(pedidos)) {
      //       table.innerHTML = `<tr><td colspan='7'>Respuesta inesperada: ${JSON.stringify(pedidos)}</td></tr>`;
      //       return;
      //     }
      //     if (pedidos.length === 0) {
      //       table.innerHTML = '<tr><td colspan="7">No hay pedidos.</td></tr>';
      //       return;
      //     }
      //     table.innerHTML = '';
      //     pedidos.forEach(p => {
      //       table.innerHTML += `<tr>
      //         <td>${p.cliente_nombre || p.cliente_correo || ''}</td>
      //         <td>${p.fecha || ''}</td>
      //         <td>${p.estado || ''}</td>
      //         <td>${p.requisitos_pdf_url ? `<a href='${p.requisitos_pdf_url}' target='_blank'>Ver PDF</a>` : ''}</td>
      //         <td>${p.articulo_pdf_url ? `<a href='${p.articulo_pdf_url}' target='_blank'>Ver PDF</a>` : ''}</td>
      //         <td>${p.correccion_pdf_url ? `<a href='${p.correccion_pdf_url}' target='_blank'>Ver PDF</a>` : ''}</td>
      //         <td><button class='btn-correccion-pedido' data-id='${p.id}' style='background:#059669;color:#fff;border:none;padding:4px 10px;border-radius:6px;cursor:pointer;'>Corregir/Devolver</button></td>
      //       </tr>`;
      //     });
      //     // Evento para mostrar panel de correcci√≥n
      //     table.querySelectorAll('.btn-correccion-pedido').forEach(btn => {
      //       btn.addEventListener('click', function() {
      //         mostrarPanelCorreccionPedido(btn.getAttribute('data-id'));
      //       });
      //     });
      //   } catch (e) {
      //     table.innerHTML = `<tr><td colspan="7">Error JS: ${e.message || e}</td></tr>`;
      //   }
      // }

      // function mostrarPanelCorreccionPedido(pedidoId) {
      //   const panel = document.getElementById('panel-correccion-pedido');
      //   panel.style.display = '';
      //   panel.querySelector('input[name="pedido_id"]').value = pedidoId;
      //   document.getElementById('msg-correccion-pedido').textContent = '';
      // }

      // // Evento para enviar PDF corregido
      // const formCorreccion = document.getElementById('form-correccion-pedido');
      // if (formCorreccion) {
      //   formCorreccion.addEventListener('submit', async function(e) {
      //     e.preventDefault();
      //     const pedidoId = formCorreccion.querySelector('input[name="pedido_id"]').value;
      //     const fileInput = formCorreccion.querySelector('input[name="pdf_correccion"]');
      //     const msg = document.getElementById('msg-correccion-pedido');
      //     msg.textContent = '';
      //     if (!pedidoId || !fileInput.files[0]) {
      //       msg.textContent = 'Selecciona un PDF.';
      //       return;
      //     }
      //     const formData = new FormData();
      //     formData.append('pdf_correccion', fileInput.files[0]);
      //     try {
      //       const res = await fetch(`/api/pedidos/${pedidoId}/correccion`, {
      //         method: 'POST',
      //         credentials: 'include',
      //         body: formData
      //       });
      //       if (res.ok) {
      //         msg.textContent = '‚úÖ PDF corregido devuelto correctamente.';
      //         cargarPedidosAdmin();
      //         panel.style.display = 'none';
      //       } else {
      //         msg.textContent = 'Error al devolver PDF: ' + (await res.text());
      //       }
      //     } catch (e) {
      //       msg.textContent = 'Error JS: ' + (e.message || e);
      //     }
      //   });
      // }

      // // Bot√≥n publicar art√≠culo (solo muestra mensaje por ahora)
      // const btnPublicar = document.getElementById('btn-publicar-articulo');
      // if (btnPublicar) {
      //   btnPublicar.onclick = function() {
      //     document.getElementById('msg-correccion-pedido').textContent = 'Funcionalidad de publicaci√≥n pendiente.';
      //   };
      // }
      // async function cargarPaginasYSecciones() {
      //   const selectPagina = document.getElementById('select-pagina');
      //   const selectSeccion = document.getElementById('select-seccion');
      //   const loader = document.getElementById('loader-editar');
      //   const msg = document.getElementById('msg-editar');
      //   loader.style.display = '';
      //   msg.style.display = 'none';
      //   selectPagina.innerHTML = '';
      //   selectSeccion.innerHTML = '';
      //   try {
      //     const res = await fetch('/api/paginas', { credentials: 'include' });
      //     const paginas = await res.json();
      //     if (!Array.isArray(paginas)) throw new Error('No se pudo cargar p√°ginas');
      //     paginas.forEach(p => {
      //       const opt = document.createElement('option');
      //       opt.value = p.nombre;
      //       opt.textContent = p.nombre;
      //       selectPagina.appendChild(opt);
      //     });
      //     selectPagina.onchange = async function() {
      //       loader.style.display = '';
      //       msg.style.display = 'none';
      //       selectSeccion.innerHTML = '';
      //       const pagina = selectPagina.value;
      //       try {
      //         const resSec = await fetch(`/api/secciones?pagina=${encodeURIComponent(pagina)}`, { credentials: 'include' });
      //         const secciones = await resSec.json();
      //         if (!Array.isArray(secciones)) throw new Error('No se pudo cargar secciones');
      //         secciones.forEach(s => {
      //           const opt = document.createElement('option');
      //           opt.value = s.seccion;
      //           opt.textContent = s.seccion;
      //           selectSeccion.appendChild(opt);
      //         });
      //         if (secciones.length > 0) {
      //           selectSeccion.value = secciones[0].seccion;
      //           await cargarContenidoSeccion();
      //         }
      //         loader.style.display = 'none';
      //       } catch (e) {
      //         loader.style.display = 'none';
      //         msg.textContent = e.message;
      //         msg.style.display = '';
      //       }
      //     };
      //     if (paginas.length > 0) {
      //       selectPagina.value = paginas[0].nombre;
      //       await selectPagina.onchange();
      //     }
      //     loader.style.display = 'none';
      //   } catch (e) {
      //     loader.style.display = 'none';
      //     msg.textContent = e.message;
      //     msg.style.display = '';
      //   }
      // }

      async function cargarContenidoSeccion() {
        const pagina = document.getElementById('select-pagina').value;
        const seccion = document.getElementById('select-seccion').value;
        const inputTitulo = document.getElementById('input-titulo');
        const editorHtml = document.getElementById('editor-html');
        const previewHtml = document.getElementById('preview-html');
        const loader = document.getElementById('loader-editar');
        const msg = document.getElementById('msg-editar');
        loader.style.display = '';
        msg.style.display = 'none';
        try {
          const res = await fetch(`/api/contenido?pagina=${encodeURIComponent(pagina)}&seccion=${encodeURIComponent(seccion)}`, { credentials: 'include' });
          const data = await res.json();
          inputTitulo.value = data.titulo || '';
          editorHtml.value = data.contenido || '';
          previewHtml.innerHTML = data.contenido || '';
          if (window.quill && document.getElementById('editor-html').style.display === 'none') {
            window.quill.root.innerHTML = data.contenido || '';
          }
          loader.style.display = 'none';
        } catch (e) {
          loader.style.display = 'none';
          msg.textContent = 'Error al cargar contenido: ' + (e.message || e);
          msg.style.display = '';
        }
      }

      function modoVisualHtml() {
        document.getElementById('editor-container').style.display = '';
        document.getElementById('editor-html').style.display = 'none';
      }
      function modoSoloHtml() {
        document.getElementById('editor-container').style.display = 'none';
        document.getElementById('editor-html').style.display = '';
      }

      // ...el resto del c√≥digo...
    });
  </script>
    <script src="/script.js"></script>
</body>
</html>
