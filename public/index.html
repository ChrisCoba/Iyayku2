<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="/css/style.css" />
  <link rel="stylesheet" href="/css/menu.css" />
  <link rel="stylesheet" href="/css/servicios.css" />
  <link rel="stylesheet" href="/css/inicio.css" />
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  <title>Iyayku – Innova Editores</title>
</head>
<body class="bg-blue-800 text-white font-sans">

  <!-- HEADER -->
  <header class="bg-white text-black flex flex-wrap items-center justify-between px-6 py-4 shadow-md">
    <!-- LOGO -->
    <div class="logo flex-shrink-0">
      <img src="/img/logo" alt="Logo" class="h-8 object-contain" />
    </div>
    <!-- Botón hamburguesa centrado debajo del logo -->
    <button id="menu-toggle" aria-label="Abrir menú">&#9776;</button>
    <!-- MENÚ -->
    <nav id="main-menu" class="w-full md:w-auto md:flex md:items-center mt-4 md:mt-0 hidden md:block">
      <ul class="flex flex-col md:flex-row gap-4 letras_menu w-full md:w-auto">
        <li><a href="#inicio" class="hover-effect block py-2 px-4">Inicio</a></li>
        <li><a href="#nosotros" class="hover-effect block py-2 px-4">Nosotros</a></li>
        <li><a href="#editorial" class="hover-effect block py-2 px-4">Editorial</a></li>
        <li><a href="#servicios" class="hover-effect block py-2 px-4">Servicios</a></li>
        <li><a href="#contacto" class="hover-effect block py-2 px-4">Contáctanos</a></li>
      </ul>
    </nav>
    <div class="social-icons">
      <a href="#registro" title="Iniciar sesión o registrarse">
        <div class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center hover:bg-blue-500 transition">
          <img src="/svg/user" alt="Usuario" class="w-6 h-6 text-white" />
        </div>
      </a>
      <!-- WhatsApp -->
      <a href="https://api.whatsapp.com/send?phone=593997000496&text=%C2%A1Hola%20Iyayku%20Innova%20Editores!%20me%20gustar%C3%ADa%20saber%20m%C3%A1s%20informaci%C3%B3n%20acerca%20de%20la%20asesor%C3%ADa%20y%20publicaci%C3%B3n%20de%20art%C3%ADculos%20cient%C3%ADficos.%20%E2%9C%8D%EF%B8%8F%F0%9F%93%8A%F0%9F%93%9D"
          target="_blank" rel="noopener noreferrer">
          <img src="/svg/whatsapp" alt="WhatsApp" class="h-5 w-5 hover:scale-110 transition" />
      </a>

      <!-- Facebook -->
      <a href="https://www.facebook.com/Iyaykutec" target="_blank" rel="noopener noreferrer">
          <img src="/svg/facebook" alt="Facebook" class="h-5 w-5 hover:scale-110 transition" />
      </a>

      <!-- Instagram -->
      <a href="https://www.instagram.com/iyaykutec" target="_blank" rel="noopener noreferrer">
          <img src="/svg/instagram" alt="Instagram" class="h-5 w-5 hover:scale-110 transition" />
      </a>

      <!-- Buscar -->
      <a id="searchToggle" class="cursor-pointer">
          <img src="/svg/lupa" alt="Buscar" class="h-5 w-5 hover:scale-110 transition" />
      </a>

      <!-- Campo de búsqueda oculto -->
      <input id="searchInput" type="text" placeholder="Buscar certificados por autor o título..."
          class="hidden ml-2 px-2 py-1 rounded border border-gray-300 shadow text-black transition-all duration-300" />
  </div>

  </header>
  <!-- Resultados de búsqueda de certificados -->
  <div id="resultados-busqueda" style="max-width:700px;margin:30px auto 0 auto;"></div>

  <!-- LOGIN STATUS BANNER -->
  <div id="login-status-banner" style="display:none;position:fixed;top:0;right:0;z-index:9999;background:#3498db;color:#fff;padding:8px 18px;border-radius:0 0 0 12px;font-weight:600;box-shadow:0 2px 8px rgba(0,0,0,0.10);">
    <span id="login-status-text"></span>
    <a id="perfil-link" href="#perfil" style="color:#fff;text-decoration:underline;margin-left:10px;display:none;">Ir a perfil</a>
  </div>

  <!-- MAIN -->
  <main>
    <div id="contenido-dinamico"></div>


    <!-- Formulario para subir PDFs tras la compra (OCULTO) -->
    <section id="formulario-pedido" style="display:none !important;">
      <!-- Formulario oculto temporalmente -->
    </section>

    <!-- Sección Mis pedidos (OCULTO) -->
    <section id="mis-pedidos" style="display:none !important;">
      <!-- Sección de pedidos oculta temporalmente -->
    </section>

    <section class="servicios-dos-columnas">
      <!-- ...existing servicios content... -->
    </section>


  </main>
 <footer class="footer">
      <div class="footer-col">
        <h3>Dirección</h3>
        <p>Dirección: Av. Amazonas y Colón, Quito – Ecuador</p>
      </div>

      <div class="footer-col">
        <h3>Síguenos</h3>
        <div class="footer-socials">
          <a href="https://api.whatsapp.com/send?phone=593997000496&text=%C2%A1Hola%20Iyayku%20Innova%20Editores!%20me%20gustar%C3%ADa%20saber%20m%C3%A1s%20informaci%C3%B3n%20acerca%20de%20la%20asesor%C3%ADa%20y%20publicaci%C3%B3n%20de%20art%C3%ADculos%20cient%C3%ADficos.%20%E2%9C%8D%EF%B8%8F%F0%9F%93%8A%F0%9F%93%9D" target="_blank" rel="noopener noreferrer">
            <img src="/svg/whatsapp" alt="WhatsApp" />
          </a>
          <a href="https://www.facebook.com/Iyaykutec" target="_blank" rel="noopener noreferrer">
            <img src="/svg/facebook" alt="Facebook" />
          </a>
          <a href="https://www.instagram.com/iyaykutec" target="_blank" rel="noopener noreferrer">
            <img src="/svg/instagram" alt="Instagram" />
          </a>
        </div>
      </div>

      <div class="footer-col">
        <h3>Información</h3>
        <p>Email: iyayku@gmail.com</p>
        <p>Teléfonos: 0995000484 · 0979369650 · 0997000496</p>
      </div>
    </footer>
  <script src="/scripts/cargaImagenes.js"></script>
  <script src="/script.js"></script>
  <script>
  // Mostrar formulario tras la compra (simulación: mostrar si el usuario está logueado)
  document.addEventListener('DOMContentLoaded', async function() {
    let usuario = null;
    try {
      const res = await fetch('/api/status', { credentials: 'include' });
      const data = await res.json();
      usuario = data.usuario;
    } catch {}
    if (usuario && usuario.id) {
      document.getElementById('formulario-pedido').style.display = '';
      document.getElementById('mis-pedidos').style.display = '';
      cargarPedidos();
    }
  });

  // Subida de PDFs
  document.getElementById('form-subir-pdfs').addEventListener('submit', async function(e) {
    e.preventDefault();
    const msg = document.getElementById('msg-pedido');
    msg.textContent = '';
    // Crear pedido primero
    let pedidoId = null;
    try {
      const descripcion = this.descripcion.value.trim();
      const resPedido = await fetch('/api/pedidos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ descripcion })
      });
      const dataPedido = await resPedido.json();
      if (!dataPedido.ok || !dataPedido.pedido) throw new Error('No se pudo crear el pedido');
      pedidoId = dataPedido.pedido.id;
    } catch (err) {
      msg.textContent = 'Error al crear pedido: ' + (err.message || err);
      return;
    }
    // Subir PDFs
    const formData = new FormData();
    formData.append('pdf_requerimiento', this.pdf_requerimiento.files[0]);
    formData.append('pdf_documento', this.pdf_documento.files[0]);
    formData.append('pedidoId', pedidoId);
    try {
      const resUpload = await fetch(`/api/pedidos/${pedidoId}/upload`, {
        method: 'POST',
        credentials: 'include',
        body: formData
      });
      const dataUpload = await resUpload.json();
      if (!dataUpload.ok) throw new Error('No se pudo subir los PDFs');
      msg.textContent = 'Documentos enviados correctamente.';
      this.reset();
      cargarPedidos();
    } catch (err) {
      msg.textContent = 'Error al subir PDFs: ' + (err.message || err);
    }
  });

  // Mostrar pedidos del usuario
  async function cargarPedidos() {
    const tabla = document.getElementById('tabla-pedidos');
    tabla.innerHTML = '<p>Cargando...</p>';
    try {
      const res = await fetch('/api/pedidos', { credentials: 'include' });
      const pedidos = await res.json();
      if (!Array.isArray(pedidos) || pedidos.length === 0) {
        tabla.innerHTML = '<p>No tienes pedidos aún.</p>';
        return;
      }
      let html = '<table style="width:100%;border-collapse:collapse;">';
      html += '<thead><tr><th>ID</th><th>Fecha</th><th>Estado</th><th>Requerimiento</th><th>Documento</th><th>Corrección</th><th>Comentarios</th></tr></thead><tbody>';
      pedidos.forEach(p => {
        html += `<tr>
          <td>${p.id}</td>
          <td>${p.fecha ? p.fecha.substring(0,19).replace('T',' ') : ''}</td>
          <td>${p.estado || ''}</td>
          <td>${p.pdf_requerimiento ? `<a href="${p.pdf_requerimiento}" target="_blank">Ver PDF</a>` : ''}</td>
          <td>${p.pdf_documento ? `<a href="${p.pdf_documento}" target="_blank">Ver PDF</a>` : ''}</td>
          <td>${p.pdf_correccion ? `<a href="${p.pdf_correccion}" target="_blank">Descargar PDF corregido</a>` : ''}</td>
          <td>${p.comentarios || ''}</td>
        </tr>`;
      });
      html += '</tbody></table>';
      tabla.innerHTML = html;
    } catch (err) {
      tabla.innerHTML = '<p>Error al cargar pedidos.</p>';
    }
  }
  </script>
  <script>
  // Búsqueda flexible de certificados desde la lupa
  (function() {
    let certificados = [];
    let certificadosCargados = false;
    const searchToggle = document.getElementById('searchToggle');
    const searchInput = document.getElementById('searchInput');
    const resultadosDiv = document.getElementById('resultados-busqueda');

    async function cargarCertificados() {
      if (certificadosCargados) return;
      try {
        const response = await fetch('/api/certificados-todos');
        certificados = await response.json();
        certificadosCargados = true;
      } catch (err) {
        certificados = [];
        certificadosCargados = true;
      }
    }

    function buscarCertificadosFlexible(searchTerm) {
      const term = searchTerm.trim().toLowerCase();
      if (!term) {
        resultadosDiv.innerHTML = '';
        return;
      }
      const resultados = certificados.filter(cert =>
        (cert.autor_nombre && cert.autor_nombre.toLowerCase().includes(term)) ||
        (cert.articulo_titulo && cert.articulo_titulo.toLowerCase().includes(term))
      );
      mostrarResultadosCertificados(resultados);
    }

    function mostrarResultadosCertificados(resultados) {
      resultadosDiv.innerHTML = '';
      if (resultados.length === 0) {
        resultadosDiv.innerHTML = '<p style="background:#fff;color:#222;padding:1em;border-radius:8px;">No se encontraron certificados.</p>';
        return;
      }
      resultados.forEach(cert => {
        const card = document.createElement('div');
        card.className = 'tarjeta-resultado';
        card.style = 'background: #fff; color: #222; margin-bottom: 1rem; padding: 1rem; border-radius: 8px;';
        const certTitulo = document.createElement('h3');
        certTitulo.textContent = cert.articulo_titulo || cert.titulo || '';
        const certAutor = document.createElement('p');
        certAutor.textContent = `Autor: ${cert.autor_nombre || cert.autor || ''}`;
        const certLink = document.createElement('a');
        certLink.href = cert.articulo_url || cert.archivo_url || '#';
        certLink.textContent = 'Ver Certificado';
        certLink.style = 'cursor:pointer; color:blue; text-decoration:underline;';
        certLink.target = '_blank';
        card.appendChild(certTitulo);
        card.appendChild(certAutor);
        card.appendChild(certLink);
        resultadosDiv.appendChild(card);
      });
    }

    if (searchToggle && searchInput) {
      searchToggle.addEventListener('click', () => {
        searchToggle.style.display = 'none';
        searchInput.classList.remove('hidden');
        searchInput.focus();
      });
      searchInput.addEventListener('blur', () => {
        searchInput.classList.add('hidden');
        searchToggle.style.display = 'inline-block';
        setTimeout(() => { resultadosDiv.innerHTML = ''; }, 200);
      });
      searchInput.addEventListener('keydown', async (e) => {
        if (e.key === 'Escape') {
          searchInput.classList.add('hidden');
          searchToggle.style.display = 'inline-block';
          resultadosDiv.innerHTML = '';
        }
        if (e.key === 'Enter') {
          e.preventDefault();
          await cargarCertificados();
          buscarCertificadosFlexible(searchInput.value);
        }
      });
    }
  })();
  </script>
  <script>
    // Menú hamburguesa responsive
    document.addEventListener('DOMContentLoaded', function() {
      var menuToggle = document.getElementById('menu-toggle');
      var mainMenu = document.getElementById('main-menu');
      menuToggle.addEventListener('click', function() {
        mainMenu.classList.toggle('open');
      });
    });
    // Mostrar banner de login si está logueado
    document.addEventListener('DOMContentLoaded', function() {
      fetch('/api/status', { credentials: 'include' })
        .then(res => res.json())
        .then(data => {
          if (data.usuario && data.usuario.correo) {
            const banner = document.getElementById('login-status-banner');
            const text = document.getElementById('login-status-text');
            const perfilLink = document.getElementById('perfil-link');
            text.textContent = `Sesión iniciada: ${data.usuario.nombre || data.usuario.correo}`;
            // Solo mostrar el link a perfil si es admin
            if (data.usuario.correo === 'admin@iyayku.com') {
              perfilLink.style.display = '';
            } else {
              perfilLink.style.display = 'none';
            }
            banner.style.display = '';
          }
        });
    });
  </script>
  <!-- Agrega esto al final de tu <body>, antes de cerrar la etiqueta -->
<script type="module">
  import { renderContacto } from '/public/pages/contacto.js';
  import { renderEditorial } from '/pages/editorial.js';
  import { renderNosotros } from '/pages/nosotros.js';
  import { renderPerfil } from '/pages/perfil.js';
  import { renderRegistroLogin } from '/pages/registroLogin.js';
  import { renderServicios } from '/pages/servicios.js';

  // Vista de inicio (puedes personalizarla)
  function renderInicio() {
    document.getElementById('contenido-dinamico').innerHTML = `
      <section class="inicio-bienvenidaa">
        <h1>Bienvenido a Iyayku Innova Editores</h1>
        <p>Tu plataformaa para publicación y asesoría científica.</p>
      </section>
    `;
  }

  // Navegación entre vistas usando hashes
  function mostrarVista(hash) {
    switch (hash) {
      case '#contacto':
        renderContacto();
        break;
      case '#editorial':
        renderEditorial();
        break;
      case '#nosotros':
        renderNosotros();
        break;
      case '#perfil':
        renderPerfil();
        break;
      case '#registro':
      case '#registro_login':
        renderRegistroLogin();
        break;
      case '#servicios':
        renderServicios();
        break;
      case '#inicio':
      case '':
        renderInicio();
        break;
      default:
        renderInicio();
    }
  }

  // Detectar navegación por hash
  window.addEventListener('hashchange', () => {
    mostrarVista(window.location.hash);
  });

  // Mostrar la vista correcta al cargar
  document.addEventListener('DOMContentLoaded', () => {
    mostrarVista(window.location.hash || '#inicio');
  });

  // Opcional: Si usas enlaces <a href="#vista"> en el menú, la navegación será automática
</script>
</body>
</html>

